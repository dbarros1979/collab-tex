<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collab-Tex - Online LaTeX Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/scroll/simplescrollbars.min.css">
    <style>
        /* CSS Variables for consistent theming */
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #34a853;
            --danger-color: #ea4335;
            --warning-color: #fbbc04;
            --dark-bg: #202124;
            --sidebar-bg: #2d2e31;
            --editor-bg: #1e1e1e;
            --text-light: #ffffff;
            --text-dark: #333333;
            --text-muted: #9aa0a6;
            --border-color: #3c4043;
            --hover-color: #35363a;
            --header-height: 50px;
            --sidebar-width: 280px;
            --footer-height: 30px;
        }

        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            height: 100vh;
            overflow: hidden;
            background-color: var(--dark-bg);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
        }

        /* Header styles */
        .header {
            height: var(--header-height);
            background-color: var(--dark-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .logo i {
            color: var(--primary-color);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .branch-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .branch-dropdown {
            position: relative;
            display: inline-block;
        }

        .branch-dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--sidebar-bg);
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            top: 100%;
            left: 0;
            margin-top: 5px;
        }

        .branch-dropdown-content.show {
            display: block;
        }

        .branch-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }

        .branch-item:hover {
            background: var(--hover-color);
        }

        .branch-item.active {
            background: var(--primary-color);
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #0d62d0;
        }

        .btn-secondary {
            background: var(--sidebar-bg);
        }

        .btn-secondary:hover {
            background: var(--hover-color);
        }

        .btn-success {
            background: var(--secondary-color);
        }

        .btn-success:hover {
            background: #2e9845;
        }

        .btn-danger {
            background: var(--danger-color);
        }

        .btn-danger:hover {
            background: #d33426;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Main container */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-section {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-section h3 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
        }

        .file-list {
            list-style: none;
        }

        .file-item,
        .folder-item {
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .file-item:hover,
        .folder-item:hover {
            background: var(--hover-color);
        }

        .file-item.active {
            background: var(--primary-color);
        }

        .file-item i {
            color: var(--text-muted);
            width: 16px;
            text-align: center;
        }

        .file-item.active i {
            color: white;
        }

        .folder-contents {
            padding-left: 20px;
            display: none;
        }

        .folder-item.expanded+.folder-contents {
            display: block;
        }

        .folder-item i {
            transition: transform 0.2s;
        }

        .folder-item.expanded i {
            transform: rotate(90deg);
        }

        /* Editor area styles */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-tabs {
            display: flex;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .editor-tab {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border-right: 1px solid var(--border-color);
            white-space: nowrap;
            transition: background 0.2s;
        }

        .editor-tab:hover {
            background: var(--hover-color);
        }

        .editor-tab.active {
            background: var(--editor-bg);
        }

        .editor-tab-close {
            margin-left: 5px;
            opacity: 0.7;
        }

        .editor-tab-close:hover {
            opacity: 1;
        }

        .editor-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .code-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 300px;
        }

        .preview-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-left: 1px solid var(--border-color);
        }

        .panel-header {
            padding: 8px 15px;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .panel-controls {
            display: flex;
            gap: 10px;
        }

        /* CodeMirror customization */
        .CodeMirror {
            flex: 1;
            height: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .CodeMirror-scroll {
            overflow: auto !important;
        }

        /* PDF Preview Styles */
        .pdf-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f0f0f0;
            overflow: hidden;
        }

        .pdf-viewer {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: auto;
            background: #525659;
            padding: 0;
        }

        .pdf-placeholder {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--text-muted);
            background: var(--sidebar-bg);
        }

        .pdf-placeholder i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--border-color);
        }

        .pdf-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .pdf-error {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--danger-color);
            background: var(--sidebar-bg);
            padding: 20px;
            text-align: center;
        }

        .pdf-error i {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* Footer styles */
        .footer {
            height: var(--footer-height);
            background: var(--dark-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .status-indicators {
            display: flex;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Compilation log styles */
        .compilation-log {
            background: var(--dark-bg);
            border-top: 1px solid var(--border-color);
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }

        .log-header {
            padding: 8px 15px;
            background: var(--sidebar-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .log-content {
            padding: 10px 15px;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
        }

        .log-success {
            color: var(--secondary-color);
        }

        .log-error {
            color: var(--danger-color);
        }

        .log-warning {
            color: var(--warning-color);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 200px;
            }

            .editor-container {
                flex-direction: column;
            }

            .code-panel,
            .preview-panel {
                width: 100%;
                height: 50%;
            }
        }

        /* Animation for compilation status */
        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .compiling {
            animation: pulse 1.5s infinite;
        }

        /* User avatars for collaborators */
        .user-item {
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
        }

        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- Header with controls -->
    <div class="header">
        <div class="logo">
            <i class="fas fa-code"></i>
            <span>Collab-Tex</span>
        </div>
        <div class="header-controls">
            <div class="branch-selector">
                <i class="fas fa-code-branch"></i>
                <div class="branch-dropdown">
                    <button class="btn btn-secondary" id="branchDropdownBtn">
                        <span id="currentBranchDisplay">Loading...</span> <i class="fas fa-caret-down"></i>
                    </button>
                    <div class="branch-dropdown-content" id="branchDropdown">
                        <div class="branch-item">
                            <span class="loading"></span> Loading branches...
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn" id="compileBtn">
                <i class="fas fa-play"></i> Compile
            </button>
            <button class="btn btn-success" id="saveBtn">
                <i class="fas fa-save"></i> Save
            </button>
            <button class="btn btn-secondary" id="reloadBtn">
                <i class="fas fa-redo"></i> Reload PDF
            </button>
        </div>
    </div>

    <!-- Main container with sidebar and editor -->
    <div class="container">
        <!-- Sidebar with file tree -->
        <div class="sidebar">
            <div class="sidebar-section">
                <h3><i class="fas fa-project-diagram"></i> Project Files</h3>
                <div class="file-tree">
                    <ul class="file-list" id="fileList">
                        <li class="file-item">
                            <span class="loading"></span> Loading files...
                        </li>
                    </ul>
                </div>
            </div>
            <div class="sidebar-section">
                <h3><i class="fas fa-users"></i> Collaborators</h3>
                <div id="collaboratorsList">
                    <div class="user-item">
                        <div class="user-avatar">DB</div>
                        <span>dbarros1979 (You)</span>
                    </div>
                    <div class="user-item">
                        <div class="user-avatar" style="background-color: var(--secondary-color);">JD</div>
                        <span>jdoe</span>
                    </div>
                    <div class="user-item">
                        <div class="user-avatar" style="background-color: var(--warning-color);">AS</div>
                        <span>asmith</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Editor area with tabs and panels -->
        <div class="editor-area">
            <div class="editor-tabs" id="editorTabs">
                <div class="editor-tab">
                    <i class="fas fa-file"></i> No file open
                </div>
            </div>

            <div class="editor-container">
                <!-- Code editor panel -->
                <div class="code-panel">
                    <div class="panel-header">
                        <span class="panel-title" id="currentFile">Select a file to edit</span>
                        <div class="panel-controls">
                            <button class="btn btn-secondary" id="undoBtn" title="Undo" disabled>
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="btn btn-secondary" id="redoBtn" title="Redo" disabled>
                                <i class="fas fa-redo"></i>
                            </button>
                            <button class="btn btn-secondary" id="wordCountBtn" title="Word Count">
                                <i class="fas fa-font"></i>
                            </button>
                        </div>
                    </div>
                    <div id="texEditor"></div>
                </div>

                <!-- PDF preview panel -->
                <div class="preview-panel">
                    <div class="panel-header">
                        <span class="panel-title">PDF Preview</span>
                        <div class="panel-controls">
                            <button class="btn btn-secondary" id="zoomOutBtn" title="Zoom Out">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="btn btn-secondary" id="zoomInBtn" title="Zoom In">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="btn btn-secondary" id="fullscreenBtn" title="Fullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="btn btn-secondary" id="downloadBtn" title="Download PDF">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <div class="pdf-container" id="pdfContainer">
                        <div class="pdf-placeholder" id="pdfPlaceholder">
                            <i class="fas fa-file-pdf"></i>
                            <p>PDF will appear here after compilation</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compilation log -->
    <div class="compilation-log" id="compilationLog">
        <div class="log-header">
            <span>Compilation Log</span>
            <button class="btn btn-secondary" id="toggleLog">
                <i class="fas fa-chevron-up"></i>
            </button>
        </div>
        <div class="log-content" id="logContent"></div>
    </div>

    <!-- Footer with status information -->
    <div class="footer">
        <div class="status-indicators">
            <div class="status-item">
                <i class="fas fa-circle" id="connectionStatus" style="color: var(--secondary-color);"></i>
                <span>Connected</span>
            </div>
            <div class="status-item">
                <i class="fas fa-save" id="saveStatus"></i>
                <span>No changes</span>
            </div>
            <div class="status-item">
                <i class="fas fa-code" id="latexStatus"></i>
                <span>LaTeX</span>
            </div>
        </div>
        <div class="status-item">
            <span id="statusMessage">Loading repository...</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/stex/stex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/scroll/simplescrollbars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/comment-fold.min.js"></script>

    <script>
        // GitHub repository configuration
        const owner = "dbarros1979";
        const repo = "collab-tex";

        // Application state
        let currentBranch = 'main';
        let currentFile = null;
        let fileContents = {};
        let openTabs = [];
        let isCompiling = false;
        let isLoggedIn = false;
        let editor;
        let editHistory = {};
        let editHistoryIndex = {};
        let pdfFrame = null;
        let currentZoom = 1.0;

        // DOM elements
        const branchDropdownBtn = document.getElementById('branchDropdownBtn');
        const branchDropdown = document.getElementById('branchDropdown');
        const currentBranchDisplay = document.getElementById('currentBranchDisplay');
        const fileList = document.getElementById('fileList');
        const editorTabs = document.getElementById('editorTabs');
        const texEditor = document.getElementById('texEditor');
        const pdfContainer = document.getElementById('pdfContainer');
        const pdfPlaceholder = document.getElementById('pdfPlaceholder');
        const currentFileElement = document.getElementById('currentFile');
        const compileBtn = document.getElementById('compileBtn');
        const reloadBtn = document.getElementById('reloadBtn');
        const saveBtn = document.getElementById('saveBtn');
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        const wordCountBtn = document.getElementById('wordCountBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const toggleLog = document.getElementById('toggleLog');
        const compilationLog = document.getElementById('compilationLog');
        const logContent = document.getElementById('logContent');
        const statusMessage = document.getElementById('statusMessage');
        const connectionStatus = document.getElementById('connectionStatus');
        const saveStatus = document.getElementById('saveStatus');
        const latexStatus = document.getElementById('latexStatus');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
            setupEventListeners();
            fetchBranches();
        });

        // Initialize application state and UI
        function initializeApp() {
            // Initialize CodeMirror editor
            editor = CodeMirror(texEditor, {
                mode: "stex",
                theme: "monokai",
                lineNumbers: true,
                lineWrapping: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                styleActiveLine: true,
                scrollbarStyle: "simple",
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                readOnly: true,
                extraKeys: {
                    "Ctrl-S": saveFile,
                    "Cmd-S": saveFile,
                    "Ctrl-Enter": compileProject,
                    "Cmd-Enter": compileProject,
                    "Ctrl-Z": undoEdit,
                    "Cmd-Z": undoEdit,
                    "Ctrl-Y": redoEdit,
                    "Shift-Ctrl-Y": redoEdit,
                    "Cmd-Y": redoEdit,
                    "Shift-Cmd-Y": redoEdit,
                    "Tab": "indentMore",
                    "Shift-Tab": "indentLess"
                }
            });

            updateSaveStatus(true);
            updateConnectionStatus(true);
        }

        // Set up all event listeners
        function setupEventListeners() {
            branchDropdownBtn.addEventListener('click', toggleBranchDropdown);
            document.addEventListener('click', closeBranchDropdown);

            compileBtn.addEventListener('click', compileProject);
            reloadBtn.addEventListener('click', reloadPDF);
            saveBtn.addEventListener('click', saveFile);
            undoBtn.addEventListener('click', undoEdit);
            redoBtn.addEventListener('click', redoEdit);
            wordCountBtn.addEventListener('click', showWordCount);
            zoomOutBtn.addEventListener('click', zoomOutPDF);
            zoomInBtn.addEventListener('click', zoomInPDF);
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            downloadBtn.addEventListener('click', downloadPDF);
            toggleLog.addEventListener('click', toggleCompilationLog);

            fileList.addEventListener('click', handleFileClick);
            editorTabs.addEventListener('click', handleTabClick);
            editor.on('change', handleEditorChange);
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        // Load branches dynamically
        async function fetchBranches() {
            try {
                statusMessage.textContent = 'Loading branches...';
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/branches`);

                if (!res.ok) {
                    throw new Error(`Failed to fetch branches: ${res.status} ${res.statusText}`);
                }

                const branches = await res.json();

                const branchDropdown = document.getElementById("branchDropdown");
                branchDropdown.innerHTML = "";

                branches.forEach(branch => {
                    const item = document.createElement("div");
                    item.className = "branch-item";
                    if (branch.name === currentBranch) {
                        item.classList.add("active");
                    }
                    item.dataset.branch = branch.name;
                    item.innerHTML = `<span>${branch.name}</span>`;
                    if (branch.name === currentBranch) {
                        item.innerHTML += '<i class="fas fa-check"></i>';
                    }
                    item.onclick = () => switchBranch(branch.name);
                    branchDropdown.appendChild(item);
                });

                currentBranchDisplay.textContent = currentBranch;
                fetchFileTree(currentBranch);

                statusMessage.textContent = 'Branches loaded';
                addToLog(`Loaded ${branches.length} branches`, 'info');
            } catch (error) {
                console.error('Error fetching branches:', error);
                statusMessage.textContent = 'Error loading branches';
                addToLog(`Error loading branches: ${error.message}`, 'error');
            }
        }

        // Load file tree dynamically
        async function fetchFileTree(branch) {
            try {
                statusMessage.textContent = 'Loading files...';
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`);

                if (!res.ok) {
                    throw new Error(`Failed to fetch file tree: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                const fileList = document.getElementById("fileList");
                fileList.innerHTML = "";

                const fileTree = {};

                data.tree
                    .filter(item => item.type === "blob")
                    .forEach(file => {
                        const pathParts = file.path.split('/');
                        let currentLevel = fileTree;

                        for (let i = 0; i < pathParts.length - 1; i++) {
                            const part = pathParts[i];
                            if (!currentLevel[part]) {
                                currentLevel[part] = {};
                            }
                            currentLevel = currentLevel[part];
                        }

                        const fileName = pathParts[pathParts.length - 1];
                        currentLevel[fileName] = file;
                    });

                renderFileTree(fileTree, fileList);

                statusMessage.textContent = 'Files loaded';
                addToLog(`Loaded file tree for branch: ${branch}`, 'info');
            } catch (error) {
                console.error('Error fetching file tree:', error);
                statusMessage.textContent = 'Error loading files';
                addToLog(`Error loading file tree: ${error.message}`, 'error');

                const fileList = document.getElementById("fileList");
                fileList.innerHTML = `<li class="file-item"><i class="fas fa-exclamation-triangle"></i> Error loading files</li>`;
            }
        }

        // Recursively render file tree
        function renderFileTree(tree, container, path = '') {
            for (const key in tree) {
                if (typeof tree[key] === 'object' && tree[key].path === undefined) {
                    const folderItem = document.createElement('li');
                    folderItem.className = 'folder-item';
                    folderItem.innerHTML = `<i class="fas fa-folder"></i> ${key}`;
                    container.appendChild(folderItem);

                    const folderContents = document.createElement('div');
                    folderContents.className = 'folder-contents';
                    container.appendChild(folderContents);

                    folderItem.addEventListener('click', function (e) {
                        e.stopPropagation();
                        this.classList.toggle('expanded');
                    });

                    renderFileTree(tree[key], folderContents, path + key + '/');
                } else {
                    const file = tree[key];
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.dataset.file = file.path;
                    li.innerHTML = `${getFileIcon(file.path)} ${key}`;
                    li.onclick = () => openFile(file.path);
                    container.appendChild(li);
                }
            }
        }

        // Load file content dynamically
        async function fetchFileContent(branch, path) {
            try {
                statusMessage.textContent = `Loading ${path}...`;
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`);

                if (!res.ok) {
                    throw new Error(`Failed to fetch file content: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                const content = atob(data.content);
                fileContents[path] = content;

                if (!editHistory[path]) {
                    editHistory[path] = [content];
                    editHistoryIndex[path] = 0;
                }

                editor.setValue(content);
                editor.setOption('readOnly', false);

                statusMessage.textContent = `Loaded: ${path}`;
                addToLog(`Loaded file: ${path}`, 'info');

                return content;
            } catch (error) {
                console.error('Error fetching file content:', error);
                statusMessage.textContent = `Error loading ${path}`;
                addToLog(`Error loading file: ${error.message}`, 'error');

                editor.setValue(`% Error loading file: ${path}\n% ${error.message}`);
                editor.setOption('readOnly', true);
            }
        }

        // Toggle branch dropdown
        function toggleBranchDropdown(e) {
            e.stopPropagation();
            branchDropdown.classList.toggle('show');
        }

        // Close branch dropdown when clicking outside
        function closeBranchDropdown(e) {
            if (!branchDropdown.contains(e.target) && e.target !== branchDropdownBtn) {
                branchDropdown.classList.remove('show');
            }
        }

        // Switch to a different branch
        function switchBranch(branchName) {
            document.querySelectorAll('.branch-item').forEach(item => {
                item.classList.remove('active');
                const icon = item.querySelector('i.fa-check');
                if (icon) icon.remove();
            });

            const activeItem = document.querySelector(`.branch-item[data-branch="${branchName}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
                activeItem.innerHTML += '<i class="fas fa-check"></i>';
            }

            currentBranch = branchName;
            currentBranchDisplay.textContent = branchName;
            branchDropdown.classList.remove('show');

            currentFile = null;
            currentFileElement.textContent = 'Select a file to edit';
            editor.setValue('');
            editor.setOption('readOnly', true);

            openTabs = [];
            editorTabs.innerHTML = '<div class="editor-tab"><i class="fas fa-file"></i> No file open</div>';

            loadBranch();
        }

        // Handle file clicks in the sidebar
        function handleFileClick(e) {
            const fileItem = e.target.closest('.file-item');
            const folderItem = e.target.closest('.folder-item');

            if (fileItem) {
                const fileName = fileItem.getAttribute('data-file');
                openFile(fileName);
            } else if (folderItem) {
                folderItem.classList.toggle('expanded');
            }
        }

        // Handle tab clicks in the editor area
        function handleTabClick(e) {
            const tab = e.target.closest('.editor-tab');
            const closeBtn = e.target.closest('.editor-tab-close');

            if (closeBtn && tab) {
                const fileName = tab.getAttribute('data-file');
                if (fileName) {
                    closeTab(fileName);
                }
            } else if (tab) {
                const fileName = tab.getAttribute('data-file');
                if (fileName) {
                    switchToTab(fileName);
                }
            }
        }

        // Handle editor input changes
        function handleEditorChange() {
            if (!currentFile) return;

            const content = editor.getValue();
            fileContents[currentFile] = content;

            if (editHistory[currentFile][editHistoryIndex[currentFile]] !== content) {
                editHistoryIndex[currentFile]++;
                editHistory[currentFile][editHistoryIndex[currentFile]] = content;

                if (editHistoryIndex[currentFile] < editHistory[currentFile].length - 1) {
                    editHistory[currentFile] = editHistory[currentFile].slice(0, editHistoryIndex[currentFile] + 1);
                }

                if (editHistory[currentFile].length > 50) {
                    editHistory[currentFile].shift();
                    editHistoryIndex[currentFile]--;
                }
            }

            updateSaveStatus(false);
            updateUndoRedoButtons();
        }

        // Handle keyboard shortcuts
        function handleKeyboardShortcuts(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveFile();
            }

            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                compileProject();
            }
        }

        // Load selected branch
        function loadBranch() {
            statusMessage.textContent = `Loading branch: ${currentBranch}`;
            updatePDFPreview();
            fetchFileTree(currentBranch);
            statusMessage.textContent = `Branch loaded: ${currentBranch}`;
            addToLog(`Switched to branch: ${currentBranch}`, 'info');
        }

        // Update PDF preview
        function updatePDFPreview() {
            const pdfUrl = `https://${owner}.github.io/${repo}/${currentBranch}/main.pdf`;

            pdfContainer.innerHTML = '';

            const pdfViewer = document.createElement('div');
            pdfViewer.className = 'pdf-viewer';

            pdfFrame = document.createElement('iframe');
            pdfFrame.className = 'pdf-frame';
            pdfFrame.src = pdfUrl;
            pdfFrame.onload = function () {
                statusMessage.textContent = 'PDF loaded';
                applyZoom();
            };
            pdfFrame.onerror = function () {
                showPDFError('PDF not available. Compile your project to generate PDF.');
            };

            pdfViewer.appendChild(pdfFrame);
            pdfContainer.appendChild(pdfViewer);
        }

        // Apply current zoom level to PDF
        function applyZoom() {
            if (pdfFrame) {
                pdfFrame.style.transform = `scale(${currentZoom})`;
                pdfFrame.style.transformOrigin = 'center top';
            }
        }

        // Show PDF error
        function showPDFError(message) {
            pdfContainer.innerHTML = '';
            const pdfError = document.createElement('div');
            pdfError.className = 'pdf-error';
            pdfError.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <h3>PDF Not Available</h3>
                <p>${message}</p>
            `;
            pdfContainer.appendChild(pdfError);
        }

        // Open a file in the editor
        function openFile(fileName) {
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.file-item[data-file="${fileName}"]`).classList.add('active');

            if (!openTabs.includes(fileName)) {
                openTabs.push(fileName);
                addTab(fileName);
            }

            switchToTab(fileName);
        }

        // Add a new editor tab
        function addTab(fileName) {
            const noFileTab = editorTabs.querySelector('.editor-tab:not([data-file])');
            if (noFileTab) {
                noFileTab.remove();
            }

            const tab = document.createElement('div');
            tab.className = 'editor-tab';
            tab.setAttribute('data-file', fileName);

            const icon = getFileIcon(fileName);
            const name = fileName.split('/').pop();

            tab.innerHTML = `
                ${icon} ${name}
                <span class="editor-tab-close"><i class="fas fa-times"></i></span>
            `;

            editorTabs.appendChild(tab);
        }

        // Switch to a specific tab
        function switchToTab(fileName) {
            document.querySelectorAll('.editor-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.querySelector(`.editor-tab[data-file="${fileName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }

            currentFile = fileName;
            currentFileElement.textContent = fileName;

            if (fileContents[fileName]) {
                editor.setValue(fileContents[fileName]);
                editor.setOption('readOnly', false);
            } else {
                fetchFileContent(currentBranch, fileName);
            }

            updateSaveStatus(true);
            updateUndoRedoButtons();
        }

        // Close a tab
        function closeTab(fileName) {
            if (openTabs.length <= 1) {
                openTabs = [];
                editorTabs.innerHTML = '<div class="editor-tab"><i class="fas fa-file"></i> No file open</div>';
                currentFile = null;
                currentFileElement.textContent = 'Select a file to edit';
                editor.setValue('');
                editor.setOption('readOnly', true);
                updateUndoRedoButtons();
                return;
            }

            const tabIndex = openTabs.indexOf(fileName);
            openTabs.splice(tabIndex, 1);

            const tabElement = document.querySelector(`.editor-tab[data-file="${fileName}"]`);
            tabElement.remove();

            if (currentFile === fileName) {
                const newActiveTab = openTabs[Math.max(0, tabIndex - 1)];
                switchToTab(newActiveTab);
            }
        }

        // Get appropriate file icon based on extension
        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            switch (ext) {
                case 'tex': return '<i class="fas fa-file-code"></i>';
                case 'bib': return '<i class="fas fa-file-alt"></i>';
                case 'png':
                case 'jpg':
                case 'jpeg':
                case 'gif': return '<i class="fas fa-file-image"></i>';
                case 'pdf': return '<i class="fas fa-file-pdf"></i>';
                default: return '<i class="fas fa-file"></i>';
            }
        }

        // Compile the LaTeX project
        function compileProject() {
            if (isCompiling) return;

            isCompiling = true;
            compileBtn.classList.add('compiling');
            statusMessage.textContent = 'Compiling...';
            simulateCompilation();
        }

        // Simulate the compilation process
        function simulateCompilation() {
            addToLog('Starting compilation...', 'info');

            setTimeout(() => {
                addToLog('Running pdflatex...', 'info');
            }, 500);

            setTimeout(() => {
                addToLog('Running bibtex...', 'info');
            }, 1000);

            setTimeout(() => {
                addToLog('Running pdflatex (second pass)...', 'info');
            }, 1500);

            setTimeout(() => {
                addToLog('Running pdflatex (final pass)...', 'info');
                addToLog('Compilation successful!', 'success');

                isCompiling = false;
                compileBtn.classList.remove('compiling');
                statusMessage.textContent = 'Compilation complete';

                setTimeout(() => {
                    reloadPDF();
                }, 300);
            }, 2000);
        }

        // Reload the PDF preview
        function reloadPDF() {
            updatePDFPreview();
            statusMessage.textContent = 'PDF reloaded';
        }

        // Save the current file
        function saveFile() {
            if (!currentFile) {
                statusMessage.textContent = 'No file to save';
                return;
            }

            statusMessage.textContent = `Saving ${currentFile}...`;

            setTimeout(() => {
                statusMessage.textContent = `Saved: ${currentFile}`;
                updateSaveStatus(true);
                addToLog(`Saved ${currentFile}`, 'info');
            }, 500);
        }

        // Undo last edit
        function undoEdit() {
            if (!currentFile || editHistoryIndex[currentFile] <= 0) return;

            editHistoryIndex[currentFile]--;
            const content = editHistory[currentFile][editHistoryIndex[currentFile]];
            editor.setValue(content);
            fileContents[currentFile] = content;
            updateUndoRedoButtons();
            statusMessage.textContent = 'Undo';
        }

        // Redo last undone edit
        function redoEdit() {
            if (!currentFile || editHistoryIndex[currentFile] >= editHistory[currentFile].length - 1) return;

            editHistoryIndex[currentFile]++;
            const content = editHistory[currentFile][editHistoryIndex[currentFile]];
            editor.setValue(content);
            fileContents[currentFile] = content;
            updateUndoRedoButtons();
            statusMessage.textContent = 'Redo';
        }

        // Update undo/redo button states
        function updateUndoRedoButtons() {
            if (!currentFile) {
                undoBtn.disabled = true;
                redoBtn.disabled = true;
                return;
            }

            undoBtn.disabled = editHistoryIndex[currentFile] <= 0;
            redoBtn.disabled = editHistoryIndex[currentFile] >= editHistory[currentFile].length - 1;
        }

        // Show word count
        function showWordCount() {
            const content = editor.getValue();
            const words = content.split(/\s+/).filter(word => word.length > 0).length;
            const characters = content.length;
            statusMessage.textContent = `Words: ${words}, Characters: ${characters}`;
        }

        // Zoom out PDF
        function zoomOutPDF() {
            if (pdfFrame) {
                currentZoom = Math.max(0.5, currentZoom - 0.1);
                applyZoom();
                statusMessage.textContent = `Zoom: ${Math.round(currentZoom * 100)}%`;
            }
        }

        // Zoom in PDF
        function zoomInPDF() {
            if (pdfFrame) {
                currentZoom = Math.min(2.0, currentZoom + 0.1);
                applyZoom();
                statusMessage.textContent = `Zoom: ${Math.round(currentZoom * 100)}%`;
            }
        }

        // Toggle fullscreen mode for PDF preview
        function toggleFullscreen() {
            if (pdfContainer.requestFullscreen) {
                pdfContainer.requestFullscreen();
            } else if (pdfContainer.webkitRequestFullscreen) {
                pdfContainer.webkitRequestFullscreen();
            }
            statusMessage.textContent = 'Fullscreen mode';
        }

        // Download the current PDF
        function downloadPDF() {
            const pdfUrl = `https://${owner}.github.io/${repo}/${currentBranch}/main.pdf`;
            if (pdfUrl) {
                const a = document.createElement('a');
                a.href = pdfUrl;
                a.download = `document-${currentBranch}-${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                statusMessage.textContent = 'Downloading PDF...';
            } else {
                statusMessage.textContent = 'No PDF available to download';
            }
        }

        // Toggle compilation log visibility
        function toggleCompilationLog() {
            const isVisible = compilationLog.style.display !== 'none';
            compilationLog.style.display = isVisible ? 'none' : 'block';
            toggleLog.innerHTML = isVisible ?
                '<i class="fas fa-chevron-down"></i>' :
                '<i class="fas fa-chevron-up"></i>';
        }

        // Add a message to the compilation log
        function addToLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        // Update the save status indicator
        function updateSaveStatus(saved) {
            if (saved) {
                saveStatus.className = 'fas fa-check';
                saveStatus.style.color = 'var(--secondary-color)';
                document.querySelector('.status-item:nth-child(2) span').textContent = 'All changes saved';
            } else {
                saveStatus.className = 'fas fa-circle';
                saveStatus.style.color = 'var(--warning-color)';
                document.querySelector('.status-item:nth-child(2) span').textContent = 'Unsaved changes';
            }
        }

        // Update the connection status indicator
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.style.color = 'var(--secondary-color)';
            } else {
                connectionStatus.style.color = 'var(--danger-color)';
            }
        }
    </script>
</body>

</html>