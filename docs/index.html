<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collab-Tex - Online LaTeX Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/scroll/simplescrollbars.min.css">

    <script src="https://cdn.jsdelivr.net/npm/latex.js/dist/latex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/latex.js/dist/latex.min.css">

    <style>
        /* CSS Variables for consistent theming */
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #34a853;
            --danger-color: #ea4335;
            --warning-color: #fbbc04;
            --dark-bg: #202124;
            --sidebar-bg: #2d2e31;
            --editor-bg: #1e1e1e;
            --text-light: #ffffff;
            --text-dark: #333333;
            --text-muted: #9aa0a6;
            --border-color: #3c4043;
            --hover-color: #35363a;
            --header-height: 50px;
            --sidebar-width: 280px;
            --footer-height: 30px;
            --resizer-width: 8px;
        }

        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            height: 100vh;
            overflow: hidden;
            background-color: var(--dark-bg);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
        }

        /* Header styles */
        .header {
            height: var(--header-height);
            background-color: var(--dark-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 100;
            flex-shrink: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .logo i {
            color: var(--primary-color);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .branch-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .branch-dropdown {
            position: relative;
            display: inline-block;
        }

        .branch-dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--sidebar-bg);
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            top: 100%;
            left: 0;
            margin-top: 5px;
        }

        .branch-dropdown-content.show {
            display: block;
        }

        .branch-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }

        .branch-item:hover {
            background: var(--hover-color);
        }

        .branch-item.active {
            background: var(--primary-color);
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            background: #0d62d0;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--sidebar-bg);
        }

        .btn-secondary:hover {
            background: var(--hover-color);
        }

        .btn-success {
            background: var(--secondary-color);
        }

        .btn-success:hover {
            background: #2e9845;
        }

        .btn-danger {
            background: var(--danger-color);
        }

        .btn-danger:hover {
            background: #d33426;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-compiling {
            position: relative;
            overflow: hidden;
        }

        .btn-compiling::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: compiling-shimmer 1.5s infinite;
        }

        @keyframes compiling-shimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        /* Main container */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            height: calc(100vh - var(--header-height) - var(--footer-height));
        }

        /* Sidebar styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
            resize: horizontal;
            min-width: 200px;
            max-width: 400px;
            overflow-x: hidden;
        }

        .sidebar:hover {
            border-right: 2px solid var(--primary-color);
        }

        .sidebar-section {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            max-height: 50%;
        }

        .sidebar-section h3 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
        }

        .file-list {
            list-style: none;
        }

        .file-item,
        .folder-item {
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .file-item:hover,
        .folder-item:hover {
            background: var(--hover-color);
            transform: translateX(2px);
        }

        .file-item.active {
            background: var(--primary-color);
            transform: translateX(0);
        }

        .file-item i {
            color: var(--text-muted);
            width: 16px;
            text-align: center;
        }

        .file-item.active i {
            color: white;
        }

        .folder-contents {
            padding-left: 20px;
            display: none;
        }

        .folder-item.expanded+.folder-contents {
            display: block;
        }

        .folder-item i {
            transition: transform 0.2s;
        }

        .folder-item.expanded i {
            transform: rotate(90deg);
        }

        /* Editor area styles */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .editor-tabs {
            display: flex;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            flex-shrink: 0;
        }

        .editor-tab {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border-right: 1px solid var(--border-color);
            white-space: nowrap;
            transition: all 0.2s;
        }

        .editor-tab:hover {
            background: var(--hover-color);
        }

        .editor-tab.active {
            background: var(--editor-bg);
            position: relative;
        }

        .editor-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-color);
        }

        .editor-tab-close {
            margin-left: 5px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .editor-tab-close:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Editor container with resizable panels */
        .editor-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .resizer {
            width: var(--resizer-width);
            background: var(--border-color);
            cursor: col-resize;
            flex-shrink: 0;
            transition: background 0.2s;
            position: relative;
            z-index: 10;
        }

        .resizer:hover,
        .resizer.resizing {
            background: var(--primary-color);
        }

        .resizer::before {
            content: '⋮';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-muted);
            font-size: 10px;
            opacity: 0.5;
        }

        .resizer:hover::before {
            opacity: 1;
            color: var(--primary-color);
        }

        .code-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 200px;
            max-width: calc(100% - 200px);
            transition: width 0.3s ease;
        }

        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 200px;
            max-width: calc(100% - 200px);
            transition: width 0.3s ease;
        }

        .panel-header {
            padding: 8px 15px;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .panel-title {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .panel-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-right: 10px;
        }

        .zoom-display {
            font-size: 0.8rem;
            color: var(--text-muted);
            min-width: 60px;
            text-align: center;
        }

        .zoom-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        /* CodeMirror customization */
        .CodeMirror {
            flex: 1;
            height: 100%;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            transition: font-size 0.3s ease;
        }

        .CodeMirror-scroll {
            overflow: auto !important;
        }

        /* PDF Preview Styles */
        .pdf-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f0f0f0;
            overflow: hidden;
            position: relative;
        }

        .pdf-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            transition: transform 0.2s ease;
            display: block;
        }

        .pdf-placeholder {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--text-muted);
            background: var(--sidebar-bg);
        }

        .pdf-placeholder i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--border-color);
        }

        .pdf-error {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--danger-color);
            background: var(--sidebar-bg);
            padding: 20px;
            text-align: center;
            overflow-y: auto;
        }

        .pdf-error i {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* Footer styles */
        .footer {
            height: var(--footer-height);
            background: var(--dark-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            font-size: 0.8rem;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .status-indicators {
            display: flex;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Compilation log styles */
        .compilation-log {
            background: var(--dark-bg);
            border-top: 1px solid var(--border-color);
            height: 150px;
            overflow-y: auto;
            display: none;
            position: absolute;
            bottom: var(--footer-height);
            left: 0;
            right: 0;
            z-index: 50;
        }

        .log-header {
            padding: 8px 15px;
            background: var(--sidebar-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            position: sticky;
            top: 0;
        }

        .log-content {
            padding: 10px 15px;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
        }

        .log-success {
            color: var(--secondary-color);
        }

        .log-error {
            color: var(--danger-color);
        }

        .log-warning {
            color: var(--warning-color);
        }

        .log-info {
            color: var(--text-light);
        }

        /* Context menu */
        .context-menu {
            position: fixed;
            background: var(--sidebar-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px 0;
            z-index: 1000;
            display: none;
            min-width: 150px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: var(--hover-color);
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 5px 0;
        }

        /* Tooltips */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-bg);
            color: var(--text-light);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            border: 1px solid var(--border-color);
            pointer-events: none;
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 200px;
                resize: vertical;
                max-width: 100%;
                min-height: 150px;
                max-height: 300px;
            }

            .editor-container {
                flex-direction: column;
            }

            .code-panel,
            .preview-panel {
                width: 100% !important;
                height: 50% !important;
                max-width: 100%;
            }

            .resizer {
                width: 100%;
                height: var(--resizer-width);
                cursor: row-resize;
            }

            .resizer::before {
                content: '⋯';
            }
        }

        /* Animation for compilation status */
        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .compiling {
            animation: pulse 1.5s infinite;
        }

        /* User avatars for collaborators */
        .user-item {
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
        }

        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--secondary-color);
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="logo">
            <i class="fas fa-code"></i>
            <span>Collab-Tex</span>
        </div>
        <div class="header-controls">
            <div class="branch-selector">
                <i class="fas fa-code-branch"></i>
                <div class="branch-dropdown">
                    <button class="btn btn-secondary" id="branchDropdownBtn">
                        <span id="currentBranchDisplay">main</span> <i class="fas fa-caret-down"></i>
                    </button>
                    <div class="branch-dropdown-content" id="branchDropdown">
                        <div class="branch-item" data-branch="main">
                            <span>main</span> <i class="fas fa-check"></i>
                        </div>
                        <div class="branch-item" data-branch="develop">
                            <span>develop</span>
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn" id="compileBtn" data-tooltip="Compile LaTeX (Ctrl+Enter)">
                <i class="fas fa-play"></i> <span id="compileText">Compile</span>
            </button>
            <button class="btn btn-success" id="saveBtn" data-tooltip="Save document (Ctrl+S)">
                <i class="fas fa-save"></i> Save
            </button>
            <button class="btn btn-secondary" id="reloadBtn" data-tooltip="Refresh PDF preview">
                <i class="fas fa-redo"></i> Refresh
            </button>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="sidebar-section" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <h3><i class="fas fa-project-diagram"></i> Project Files</h3>
                <div class="file-tree" id="fileTreeContainer">
                    <ul class="file-list" id="fileList">
                        <li class="file-item active" data-file="main.tex">
                            <i class="fas fa-file-code"></i> main.tex
                        </li>
                        <li class="file-item" data-file="references.bib">
                            <i class="fas fa-file-alt"></i> references.bib
                        </li>
                        <li class="folder-item">
                            <i class="fas fa-folder"></i> images
                        </li>
                        <div class="folder-contents">
                            <li class="file-item" data-file="images/diagram.png">
                                <i class="fas fa-file-image"></i> diagram.png
                            </li>
                        </div>
                    </ul>
                </div>
            </div>
            <div class="sidebar-section" style="max-height: 150px; overflow-y: auto;">
                <h3><i class="fas fa-users"></i> Collaborators</h3>
                <div id="collaboratorsList">
                    <div class="user-item">
                        <div class="user-avatar">DB</div>
                        <span>dbarros1979 (You)</span>
                    </div>
                    <div class="user-item">
                        <div class="user-avatar" style="background-color: var(--secondary-color);">JD</div>
                        <span>jdoe</span>
                    </div>
                    <div class="user-item">
                        <div class="user-avatar" style="background-color: var(--warning-color);">AS</div>
                        <span>asmith</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="editor-area">
            <div class="editor-tabs" id="editorTabs">
                <div class="editor-tab active" data-file="main.tex">
                    <i class="fas fa-file-code"></i> main.tex
                    <span class="editor-tab-close"><i class="fas fa-times"></i></span>
                </div>
            </div>

            <div class="editor-container">
                <div class="code-panel" id="codePanel">
                    <div class="panel-header">
                        <span class="panel-title" id="currentFile">main.tex</span>
                        <div class="panel-controls">
                            <div class="zoom-controls">
                                <button class="btn btn-secondary zoom-btn" id="fontSmallerBtn" data-tooltip="Decrease font size">
                                    <i class="fas fa-font"></i><i class="fas fa-minus" style="font-size: 8px;"></i>
                                </button>
                                <span class="zoom-display" id="fontSizeDisplay">14px</span>
                                <button class="btn btn-secondary zoom-btn" id="fontLargerBtn" data-tooltip="Increase font size">
                                    <i class="fas fa-font"></i><i class="fas fa-plus" style="font-size: 8px;"></i>
                                </button>
                            </div>
                            <button class="btn btn-secondary" id="undoBtn" title="Undo (Ctrl+Z)" data-tooltip="Undo (Ctrl+Z)" disabled>
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="btn btn-secondary" id="redoBtn" title="Redo (Ctrl+Y)" data-tooltip="Redo (Ctrl+Y)" disabled>
                                <i class="fas fa-redo"></i>
                            </button>
                            <button class="btn btn-secondary" id="wordCountBtn" data-tooltip="Word count">
                                <i class="fas fa-font"></i>
                            </button>
                        </div>
                    </div>
                    <div style="flex: 1; overflow: hidden; height: 100%;">
                        <textarea id="texEditor"></textarea>
                    </div>
                </div>

                <div class="resizer" id="resizer"></div>

                <div class="preview-panel" id="previewPanel">
                    <div class="panel-header">
                        <span class="panel-title">Preview</span>
                        <div class="panel-controls">
                            <div class="zoom-controls">
                                <button class="btn btn-secondary zoom-btn" id="zoomOutBtn" data-tooltip="Zoom Out PDF">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                                <span class="zoom-display" id="zoomDisplay">100%</span>
                                <button class="btn btn-secondary zoom-btn" id="zoomResetBtn" data-tooltip="Reset Zoom">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-secondary zoom-btn" id="zoomInBtn" data-tooltip="Zoom In PDF">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                            </div>
                            <button class="btn btn-secondary" id="fullscreenBtn" data-tooltip="Fullscreen preview">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="btn btn-secondary" id="downloadBtn" data-tooltip="Download PDF">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <div class="pdf-container" id="pdfContainer">
                        <div class="pdf-placeholder" id="pdfPlaceholder">
                            <i class="fas fa-file-pdf"></i>
                            <p>Document preview will appear here after compilation</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="compilation-log" id="compilationLog">
        <div class="log-header">
            <span>Compilation Log</span>
            <button class="btn btn-secondary" id="toggleLog">
                <i class="fas fa-chevron-up"></i>
            </button>
        </div>
        <div class="log-content" id="logContent"></div>
    </div>

    <div class="footer">
        <div class="status-indicators">
            <div class="status-item">
                <i class="fas fa-circle" id="connectionStatus" style="color: var(--secondary-color);"></i>
                <span>Connected</span>
            </div>
            <div class="status-item">
                <i class="fas fa-save" id="saveStatus"></i>
                <span id="saveStatusText">No changes</span>
            </div>
            <div class="status-item">
                <i class="fas fa-code" id="latexStatus"></i>
                <span>LaTeX</span>
            </div>
        </div>
        <div class="status-item">
            <span id="statusMessage">Ready</span>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <div class="context-menu" id="contextMenu"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/stex/stex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/scroll/simplescrollbars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/comment-fold.min.js"></script>

    <script>
        // Application state
        let currentBranch = 'main';
        let currentFile = 'main.tex';
        let fileContents = {};
        let openTabs = ['main.tex'];
        let isCompiling = false;
        let isLoggedIn = false;
        let editor;
        let editHistory = {};
        let editHistoryIndex = {};
        let pdfFrame = null;
        let currentZoom = 1.0;
        let editorFontSize = 14;
        let isResizing = false;
        let lastDownX = 0;
        let codePanelWidth = 50; // percentage
        let previewPanelWidth = 50; // percentage

        // DOM elements
        const branchDropdownBtn = document.getElementById('branchDropdownBtn');
        const branchDropdown = document.getElementById('branchDropdown');
        const currentBranchDisplay = document.getElementById('currentBranchDisplay');
        const fileList = document.getElementById('fileList');
        const editorTabs = document.getElementById('editorTabs');
        const texEditor = document.getElementById('texEditor');
        const pdfContainer = document.getElementById('pdfContainer');
        const pdfPlaceholder = document.getElementById('pdfPlaceholder');
        const currentFileElement = document.getElementById('currentFile');
        const compileBtn = document.getElementById('compileBtn');
        const compileText = document.getElementById('compileText');
        const reloadBtn = document.getElementById('reloadBtn');
        const saveBtn = document.getElementById('saveBtn');
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        const wordCountBtn = document.getElementById('wordCountBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomResetBtn = document.getElementById('zoomResetBtn');
        const zoomDisplay = document.getElementById('zoomDisplay');
        const fontSmallerBtn = document.getElementById('fontSmallerBtn');
        const fontLargerBtn = document.getElementById('fontLargerBtn');
        const fontSizeDisplay = document.getElementById('fontSizeDisplay');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const toggleLog = document.getElementById('toggleLog');
        const compilationLog = document.getElementById('compilationLog');
        const logContent = document.getElementById('logContent');
        const statusMessage = document.getElementById('statusMessage');
        const connectionStatus = document.getElementById('connectionStatus');
        const saveStatus = document.getElementById('saveStatus');
        const saveStatusText = document.getElementById('saveStatusText');
        const latexStatus = document.getElementById('latexStatus');
        const notification = document.getElementById('notification');
        const resizer = document.getElementById('resizer');
        const codePanel = document.getElementById('codePanel');
        const previewPanel = document.getElementById('previewPanel');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
            setupEventListeners();
            setupResizablePanels();
            showNotification('Welcome to Collab-Tex!', 'info');
        });

        // Initialize application state and UI
        function initializeApp() {
            // Initialize CodeMirror editor
            editor = CodeMirror.fromTextArea(texEditor, {
                mode: "stex",
                theme: "monokai",
                lineNumbers: true,
                lineWrapping: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                styleActiveLine: true,
                scrollbarStyle: "simple",
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: {
                    "Ctrl-S": saveFile,
                    "Cmd-S": saveFile,
                    "Ctrl-Enter": compileProject,
                    "Cmd-Enter": compileProject,
                    "Ctrl-Z": undoEdit,
                    "Cmd-Z": undoEdit,
                    "Ctrl-Y": redoEdit,
                    "Shift-Ctrl-Y": redoEdit,
                    "Cmd-Y": redoEdit,
                    "Shift-Cmd-Y": redoEdit,
                    "Tab": "indentMore",
                    "Shift-Tab": "indentLess"
                }
            });

            // Set initial content
            const initialContent = `\\documentclass{article}
\\usepackage{graphicx}
\\usepackage{amsmath}
\\title{Welcome to Collab-Tex}
\\author{Your Name}
\\date{\\today}

\\begin{document}
\\maketitle

\\section{Introduction}
Collab-Tex is an online LaTeX editor with real-time collaboration features. 
Start typing your LaTeX here and click the \\textbf{Compile} button to see the result.

\\subsection{Features}
\\begin{itemize}
    \\item Real-time collaboration
    \\item Live preview
    \\item Multiple file support
    \\item Version control integration
\\end{itemize}

\\section{Mathematical Examples}
Here's an example of mathematical typesetting:

\\begin{equation}
    E = mc^2
\\end{equation}

And the quadratic formula:
\\[
    x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}
\\]

\\section{Resize and Zoom Test}
Try resizing the panels by dragging the separator between the editor and preview.
Use the zoom controls to adjust the PDF preview size.

\\end{document}`;

            editor.setValue(initialContent);
            fileContents['main.tex'] = initialContent;
            editHistory['main.tex'] = [initialContent];
            editHistoryIndex['main.tex'] = 0;

            updateSaveStatus(true);
            updateConnectionStatus(true);
            updateFontSizeDisplay();
        }

        // Set up all event listeners
        function setupEventListeners() {
            branchDropdownBtn.addEventListener('click', toggleBranchDropdown);
            document.addEventListener('click', closeBranchDropdown);

            compileBtn.addEventListener('click', compileProject);
            reloadBtn.addEventListener('click', reloadPDF);
            saveBtn.addEventListener('click', saveFile);
            undoBtn.addEventListener('click', undoEdit);
            redoBtn.addEventListener('click', redoEdit);
            wordCountBtn.addEventListener('click', showWordCount);
            zoomOutBtn.addEventListener('click', zoomOutPDF);
            zoomInBtn.addEventListener('click', zoomInPDF);
            zoomResetBtn.addEventListener('click', resetZoomPDF);
            fontSmallerBtn.addEventListener('click', decreaseFontSize);
            fontLargerBtn.addEventListener('click', increaseFontSize);
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            downloadBtn.addEventListener('click', downloadPDF);
            toggleLog.addEventListener('click', toggleCompilationLog);

            fileList.addEventListener('click', handleFileClick);
            editorTabs.addEventListener('click', handleTabClick);
            editor.on('change', handleEditorChange);
            document.addEventListener('keydown', handleKeyboardShortcuts);

            // Branch switching
            document.querySelectorAll('.branch-item').forEach(item => {
                item.addEventListener('click', () => {
                    const branch = item.dataset.branch;
                    switchBranch(branch);
                });
            });
        }

        // Setup resizable panels
        function setupResizablePanels() {
            resizer.addEventListener('mousedown', function (e) {
                isResizing = true;
                lastDownX = e.clientX;
                resizer.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });

            // Touch support for mobile
            resizer.addEventListener('touchstart', function (e) {
                isResizing = true;
                lastDownX = e.touches[0].clientX;
                resizer.classList.add('resizing');
                document.body.style.userSelect = 'none';

                document.addEventListener('touchmove', handleTouchMove);
                document.addEventListener('touchend', handleTouchEnd);
            });
        }

        function handleMouseMove(e) {
            if (!isResizing) return;

            const containerWidth = document.querySelector('.editor-container').offsetWidth;
            const deltaX = e.clientX - lastDownX;
            const deltaPercent = (deltaX / containerWidth) * 100;

            codePanelWidth = Math.max(20, Math.min(80, codePanelWidth + deltaPercent));
            previewPanelWidth = 100 - codePanelWidth;

            updatePanelSizes();
            lastDownX = e.clientX;
        }

        function handleMouseUp() {
            if (!isResizing) return;

            isResizing = false;
            resizer.classList.remove('resizing');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';

            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        }

        function handleTouchMove(e) {
            if (!isResizing || !e.touches[0]) return;

            const containerWidth = document.querySelector('.editor-container').offsetWidth;
            const deltaX = e.touches[0].clientX - lastDownX;
            const deltaPercent = (deltaX / containerWidth) * 100;

            codePanelWidth = Math.max(20, Math.min(80, codePanelWidth + deltaPercent));
            previewPanelWidth = 100 - codePanelWidth;

            updatePanelSizes();
            lastDownX = e.touches[0].clientX;
        }

        function handleTouchEnd() {
            if (!isResizing) return;

            isResizing = false;
            resizer.classList.remove('resizing');
            document.body.style.userSelect = '';

            document.removeEventListener('touchmove', handleTouchMove);
            document.removeEventListener('touchend', handleTouchEnd);
        }

        function updatePanelSizes() {
            codePanel.style.width = `${codePanelWidth}%`;
            previewPanel.style.width = `${previewPanelWidth}%`;
        }

        // Compile LaTeX project
        async function compileProject() {
            if (isCompiling) return;

            isCompiling = true;
            compileBtn.classList.add('btn-compiling');
            compileText.textContent = 'Compiling...';
            compileBtn.disabled = true;

            statusMessage.textContent = 'Compiling LaTeX...';
            addToLog('Starting compilation...', 'info');

            try {
                const source = editor.getValue();

                // Show compilation in progress
                pdfContainer.innerHTML = `
                    <div class="pdf-placeholder">
                        <div class="loading" style="width: 40px; height: 40px; margin-bottom: 15px;"></div>
                        <p>Compiling LaTeX document...</p>
                    </div>
                `;

                // Simulate compilation delay
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Render LaTeX
                await renderLatexToPreview(source);

                showNotification('Compilation successful!', 'success');
                statusMessage.textContent = 'Compilation complete';
                addToLog('Compilation successful!', 'success');

            } catch (error) {
                console.error('Compilation error:', error);
                showPDFError(error.message);
                showNotification(`Compilation failed: ${error.message}`, 'error');
                statusMessage.textContent = 'Compilation failed';
                addToLog(`Compilation error: ${error.message}`, 'error');
            } finally {
                isCompiling = false;
                compileBtn.classList.remove('btn-compiling');
                compileText.textContent = 'Compile';
                compileBtn.disabled = false;
            }
        }

        // Render Latex to Preview
        async function renderLatexToPreview(sourceCode) {
            pdfContainer.innerHTML = '';

            // Create iframe
            const iframe = document.createElement('iframe');
            iframe.className = 'pdf-frame';
            iframe.id = 'pdfFrame';

            pdfContainer.appendChild(iframe);
            pdfFrame = iframe;

            try {
                const generator = new latexjs.HtmlGenerator({ hyphenate: false });
                const doc = latexjs.parse(sourceCode, { generator: generator });

                const head = `
                    <head>
                        <meta charset="UTF-8">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/latex.js/dist/latex.min.css">
                        <style>
                            body { 
                                margin: 40px; 
                                overflow-y: auto;
                                background: white;
                                font-family: "Latin Modern", serif;
                            }
                            @page { margin: 0; }
                        </style>
                    </head>
                `;

                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(head);
                iframeDoc.write('<body>');
                iframeDoc.write('</body>');
                iframeDoc.close();

                iframeDoc.body.appendChild(generator.domFragment());
                applyZoom();

            } catch (e) {
                throw new Error(e.message);
            }
        }

        // Zoom controls
        function zoomOutPDF() {
            currentZoom = Math.max(0.25, currentZoom - 0.1);
            applyZoom();
            updateZoomDisplay();
        }

        function zoomInPDF() {
            currentZoom = Math.min(3.0, currentZoom + 0.1);
            applyZoom();
            updateZoomDisplay();
        }

        function resetZoomPDF() {
            currentZoom = 1.0;
            applyZoom();
            updateZoomDisplay();
        }

        function applyZoom() {
            if (pdfFrame) {
                pdfFrame.style.transform = `scale(${currentZoom})`;
                pdfFrame.style.transformOrigin = 'top center';
                pdfFrame.style.width = `${100 / currentZoom}%`;
                pdfFrame.style.height = `${100 / currentZoom}%`;
            }
        }

        function updateZoomDisplay() {
            zoomDisplay.textContent = `${Math.round(currentZoom * 100)}%`;
        }

        // Editor font size controls
        function decreaseFontSize() {
            editorFontSize = Math.max(10, editorFontSize - 1);
            editor.getWrapperElement().style.fontSize = `${editorFontSize}px`;
            editor.refresh();
            updateFontSizeDisplay();
        }

        function increaseFontSize() {
            editorFontSize = Math.min(24, editorFontSize + 1);
            editor.getWrapperElement().style.fontSize = `${editorFontSize}px`;
            editor.refresh();
            updateFontSizeDisplay();
        }

        function updateFontSizeDisplay() {
            fontSizeDisplay.textContent = `${editorFontSize}px`;
        }

        // File management
        function openFile(fileName) {
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.file-item[data-file="${fileName}"]`).classList.add('active');

            if (!openTabs.includes(fileName)) {
                openTabs.push(fileName);
                addTab(fileName);
            }

            switchToTab(fileName);
        }

        function addTab(fileName) {
            const tab = document.createElement('div');
            tab.className = 'editor-tab';
            tab.setAttribute('data-file', fileName);

            const icon = getFileIcon(fileName);
            const name = fileName.split('/').pop();

            tab.innerHTML = `
                ${icon} ${name}
                <span class="editor-tab-close"><i class="fas fa-times"></i></span>
            `;

            editorTabs.appendChild(tab);
            editorTabs.querySelector('.editor-tab.active')?.classList.remove('active');
            tab.classList.add('active');
        }

        function switchToTab(fileName) {
            document.querySelectorAll('.editor-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.querySelector(`.editor-tab[data-file="${fileName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }

            currentFile = fileName;
            currentFileElement.textContent = fileName;

            if (fileContents[fileName]) {
                editor.setValue(fileContents[fileName]);
            } else {
                // For new files, create empty content
                fileContents[fileName] = '';
                editHistory[fileName] = [''];
                editHistoryIndex[fileName] = 0;
                editor.setValue('');
            }

            updateSaveStatus(true);
            updateUndoRedoButtons();
        }

        function closeTab(fileName) {
            if (openTabs.length <= 1) return;

            const tabIndex = openTabs.indexOf(fileName);
            openTabs.splice(tabIndex, 1);

            const tabElement = document.querySelector(`.editor-tab[data-file="${fileName}"]`);
            tabElement.remove();

            if (currentFile === fileName) {
                const newActiveTab = openTabs[Math.max(0, tabIndex - 1)];
                switchToTab(newActiveTab);
            }
        }

        // Event handlers
        function handleFileClick(e) {
            const fileItem = e.target.closest('.file-item');
            const folderItem = e.target.closest('.folder-item');

            if (fileItem) {
                const fileName = fileItem.getAttribute('data-file');
                openFile(fileName);
            } else if (folderItem) {
                folderItem.classList.toggle('expanded');
            }
        }

        function handleTabClick(e) {
            const tab = e.target.closest('.editor-tab');
            const closeBtn = e.target.closest('.editor-tab-close');

            if (closeBtn && tab) {
                const fileName = tab.getAttribute('data-file');
                if (fileName) {
                    closeTab(fileName);
                    e.stopPropagation();
                }
            } else if (tab) {
                const fileName = tab.getAttribute('data-file');
                if (fileName) {
                    switchToTab(fileName);
                }
            }
        }

        function handleEditorChange() {
            if (!currentFile) return;

            const content = editor.getValue();
            fileContents[currentFile] = content;

            if (editHistory[currentFile][editHistoryIndex[currentFile]] !== content) {
                editHistoryIndex[currentFile]++;
                editHistory[currentFile][editHistoryIndex[currentFile]] = content;

                if (editHistoryIndex[currentFile] < editHistory[currentFile].length - 1) {
                    editHistory[currentFile] = editHistory[currentFile].slice(0, editHistoryIndex[currentFile] + 1);
                }

                if (editHistory[currentFile].length > 50) {
                    editHistory[currentFile].shift();
                    editHistoryIndex[currentFile]--;
                }
            }

            updateSaveStatus(false);
            updateUndoRedoButtons();
        }

        function handleKeyboardShortcuts(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveFile();
            }

            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                compileProject();
            }
        }

        // Other functions
        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            switch (ext) {
                case 'tex': return '<i class="fas fa-file-code"></i>';
                case 'bib': return '<i class="fas fa-file-alt"></i>';
                case 'png':
                case 'jpg':
                case 'jpeg':
                case 'gif': return '<i class="fas fa-file-image"></i>';
                case 'pdf': return '<i class="fas fa-file-pdf"></i>';
                default: return '<i class="fas fa-file"></i>';
            }
        }

        function reloadPDF() {
            if (fileContents[currentFile]) {
                compileProject();
            }
        }

        function saveFile() {
            if (!currentFile) return;

            showNotification(`Saved: ${currentFile}`, 'success');
            updateSaveStatus(true);
            addToLog(`Saved ${currentFile}`, 'info');
        }

        function downloadPDF() {
            showNotification('PDF download simulated', 'info');
            // In a real implementation, this would generate and download a PDF
        }

        function undoEdit() {
            if (!currentFile || editHistoryIndex[currentFile] <= 0) return;

            editHistoryIndex[currentFile]--;
            const content = editHistory[currentFile][editHistoryIndex[currentFile]];
            editor.setValue(content);
            fileContents[currentFile] = content;
            updateUndoRedoButtons();
            showNotification('Undo', 'info');
        }

        function redoEdit() {
            if (!currentFile || editHistoryIndex[currentFile] >= editHistory[currentFile].length - 1) return;

            editHistoryIndex[currentFile]++;
            const content = editHistory[currentFile][editHistoryIndex[currentFile]];
            editor.setValue(content);
            fileContents[currentFile] = content;
            updateUndoRedoButtons();
            showNotification('Redo', 'info');
        }

        function updateUndoRedoButtons() {
            if (!currentFile) {
                undoBtn.disabled = true;
                redoBtn.disabled = true;
                return;
            }

            undoBtn.disabled = editHistoryIndex[currentFile] <= 0;
            redoBtn.disabled = editHistoryIndex[currentFile] >= editHistory[currentFile].length - 1;
        }

        function showWordCount() {
            const content = editor.getValue();
            const words = content.split(/\s+/).filter(word => word.length > 0).length;
            const characters = content.length;
            showNotification(`Words: ${words}, Characters: ${characters}`, 'info');
        }

        function toggleFullscreen() {
            if (!pdfFrame) return;

            if (!document.fullscreenElement) {
                if (pdfFrame.requestFullscreen) {
                    pdfFrame.requestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function toggleBranchDropdown(e) {
            e.stopPropagation();
            branchDropdown.classList.toggle('show');
        }

        function closeBranchDropdown(e) {
            if (!branchDropdown.contains(e.target) && e.target !== branchDropdownBtn) {
                branchDropdown.classList.remove('show');
            }
        }

        function switchBranch(branchName) {
            currentBranch = branchName;
            currentBranchDisplay.textContent = branchName;
            branchDropdown.classList.remove('show');

            // Update UI
            document.querySelectorAll('.branch-item').forEach(item => {
                item.classList.remove('active');
                item.querySelector('i.fa-check')?.remove();
            });

            const activeItem = document.querySelector(`.branch-item[data-branch="${branchName}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
                activeItem.innerHTML += '<i class="fas fa-check"></i>';
            }

            showNotification(`Switched to branch: ${branchName}`, 'info');
        }

        function toggleCompilationLog() {
            const isVisible = compilationLog.style.display !== 'none';
            compilationLog.style.display = isVisible ? 'none' : 'block';
            toggleLog.innerHTML = isVisible ?
                '<i class="fas fa-chevron-down"></i>' :
                '<i class="fas fa-chevron-up"></i>';
        }

        function addToLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        function updateSaveStatus(saved) {
            if (saved) {
                saveStatus.className = 'fas fa-check';
                saveStatus.style.color = 'var(--secondary-color)';
                saveStatusText.textContent = 'All changes saved';
            } else {
                saveStatus.className = 'fas fa-circle';
                saveStatus.style.color = 'var(--warning-color)';
                saveStatusText.textContent = 'Unsaved changes';
            }
        }

        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.style.color = 'var(--secondary-color)';
            } else {
                connectionStatus.style.color = 'var(--danger-color)';
            }
        }

        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showPDFError(message) {
            pdfContainer.innerHTML = '';
            const pdfError = document.createElement('div');
            pdfError.className = 'pdf-error';
            pdfError.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Compilation Error</h3>
                <p>${message}</p>
                <button class="btn btn-secondary" onclick="compileProject()" style="margin-top: 20px;">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            `;
            pdfContainer.appendChild(pdfError);
        }
    </script>
</body>

</html>