<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collab-Tex - Online LaTeX Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/scroll/simplescrollbars.min.css">
    <style>
        /* CSS Variables for consistent theming */
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #34a853;
            --danger-color: #ea4335;
            --warning-color: #fbbc04;
            --dark-bg: #202124;
            --sidebar-bg: #2d2e31;
            --editor-bg: #1e1e1e;
            --text-light: #ffffff;
            --text-dark: #333333;
            --text-muted: #9aa0a6;
            --border-color: #3c4043;
            --hover-color: #35363a;
            --header-height: 50px;
            --sidebar-width: 280px;
            --footer-height: 30px;
        }

        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            height: 100vh;
            overflow: hidden;
            background-color: var(--dark-bg);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
        }

        /* Header styles */
        .header {
            height: var(--header-height);
            background-color: var(--dark-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .logo i {
            color: var(--primary-color);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .branch-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .branch-dropdown {
            position: relative;
            display: inline-block;
        }

        .branch-dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--sidebar-bg);
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            top: 100%;
            left: 0;
            margin-top: 5px;
        }

        .branch-dropdown-content.show {
            display: block;
        }

        .branch-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }

        .branch-item:hover {
            background: var(--hover-color);
        }

        .branch-item.active {
            background: var(--primary-color);
        }

        .branch-actions {
            display: flex;
            gap: 10px;
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
        }

        select {
            background: var(--sidebar-bg);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 0.9rem;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #0d62d0;
        }

        .btn-secondary {
            background: var(--sidebar-bg);
        }

        .btn-secondary:hover {
            background: var(--hover-color);
        }

        .btn-success {
            background: var(--secondary-color);
        }

        .btn-success:hover {
            background: #2e9845;
        }

        .btn-danger {
            background: var(--danger-color);
        }

        .btn-danger:hover {
            background: #d33426;
        }

        /* Main container */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-section {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-section h3 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
        }

        .file-list {
            list-style: none;
        }

        .file-item,
        .folder-item {
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .file-item:hover,
        .folder-item:hover {
            background: var(--hover-color);
        }

        .file-item.active {
            background: var(--primary-color);
        }

        .file-item i {
            color: var(--text-muted);
            width: 16px;
            text-align: center;
        }

        .file-item.active i {
            color: white;
        }

        .folder-contents {
            padding-left: 20px;
            display: none;
        }

        .folder-item.expanded+.folder-contents {
            display: block;
        }

        .folder-item i {
            transition: transform 0.2s;
        }

        .folder-item.expanded i {
            transform: rotate(90deg);
        }

        /* Editor area styles */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-tabs {
            display: flex;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .editor-tab {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border-right: 1px solid var(--border-color);
            white-space: nowrap;
            transition: background 0.2s;
        }

        .editor-tab:hover {
            background: var(--hover-color);
        }

        .editor-tab.active {
            background: var(--editor-bg);
        }

        .editor-tab-close {
            margin-left: 5px;
            opacity: 0.7;
        }

        .editor-tab-close:hover {
            opacity: 1;
        }

        .editor-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .code-panel,
        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 8px 15px;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .panel-controls {
            display: flex;
            gap: 10px;
        }

        .resize-handle {
            width: 5px;
            background: var(--border-color);
            cursor: col-resize;
            transition: background 0.2s;
        }

        .resize-handle:hover {
            background: var(--primary-color);
        }

        /* CodeMirror customization */
        .CodeMirror {
            flex: 1;
            height: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .CodeMirror-scroll {
            overflow: auto !important;
        }

        #pdfFrame {
            flex: 1;
            border: none;
            background: white;
        }

        /* Footer styles */
        .footer {
            height: var(--footer-height);
            background: var(--dark-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .status-indicators {
            display: flex;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Compilation log styles */
        .compilation-log {
            background: var(--dark-bg);
            border-top: 1px solid var(--border-color);
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }

        .log-header {
            padding: 8px 15px;
            background: var(--sidebar-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .log-content {
            padding: 10px 15px;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
        }

        .log-success {
            color: var(--secondary-color);
        }

        .log-error {
            color: var(--danger-color);
        }

        .log-warning {
            color: var(--warning-color);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 200px;
            }

            .editor-container {
                flex-direction: column;
            }

            .code-panel,
            .preview-panel {
                height: 50%;
            }

            .resize-handle {
                width: 100%;
                height: 5px;
                cursor: row-resize;
            }
        }

        /* Animation for compilation status */
        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .compiling {
            animation: pulse 1.5s infinite;
        }

        /* User avatars for collaborators */
        .user-item {
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
        }
    </style>
</head>

<body>
    <!-- Header with controls -->
    <div class="header">
        <div class="logo">
            <i class="fas fa-code"></i>
            <span>Collab-Tex</span>
        </div>
        <div class="header-controls">
            <div class="branch-selector">
                <i class="fas fa-code-branch"></i>
                <div class="branch-dropdown">
                    <button class="btn btn-secondary" id="branchDropdownBtn">
                        <span id="currentBranchDisplay">main</span> <i class="fas fa-caret-down"></i>
                    </button>
                    <div class="branch-dropdown-content" id="branchDropdown">
                        <div class="branch-item active" data-branch="main">
                            <span>main</span>
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="branch-item" data-branch="develop">
                            <span>develop</span>
                        </div>
                        <div class="branch-item" data-branch="feature-x">
                            <span>feature-x</span>
                        </div>
                        <div class="branch-actions">
                            <button class="btn btn-secondary" id="newBranchBtn">
                                <i class="fas fa-plus"></i> New Branch
                            </button>
                            <button class="btn btn-secondary" id="manageBranchesBtn">
                                <i class="fas fa-cog"></i> Manage
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn" id="compileBtn">
                <i class="fas fa-play"></i> Compile
            </button>
            <button class="btn btn-success" id="saveBtn">
                <i class="fas fa-save"></i> Save
            </button>
            <button class="btn btn-secondary" id="reloadBtn">
                <i class="fas fa-redo"></i> Reload PDF
            </button>
        </div>
    </div>

    <!-- Main container with sidebar and editor -->
    <div class="container">
        <!-- Sidebar with file tree -->
        <div class="sidebar">
            <div class="sidebar-section">
                <h3><i class="fas fa-project-diagram"></i> Project Files</h3>
                <div class="file-tree">
                    <ul class="file-list" id="fileList">
                        <li class="file-item active" data-file="main.tex">
                            <i class="fas fa-file-code"></i> main.tex
                        </li>
                        <li class="file-item" data-file="references.bib">
                            <i class="fas fa-file-alt"></i> references.bib
                        </li>
                        <li class="folder-item">
                            <i class="fas fa-folder"></i> figures
                        </li>
                        <div class="folder-contents">
                            <li class="file-item" data-file="figures/diagram1.png">
                                <i class="fas fa-file-image"></i> diagram1.png
                            </li>
                            <li class="file-item" data-file="figures/chart.pdf">
                                <i class="fas fa-chart-bar"></i> chart.pdf
                            </li>
                        </div>
                        <li class="folder-item">
                            <i class="fas fa-folder"></i> sections
                        </li>
                        <div class="folder-contents">
                            <li class="file-item" data-file="sections/introduction.tex">
                                <i class="fas fa-file-code"></i> introduction.tex
                            </li>
                            <li class="file-item" data-file="sections/methodology.tex">
                                <i class="fas fa-file-code"></i> methodology.tex
                            </li>
                            <li class="file-item" data-file="sections/results.tex">
                                <i class="fas fa-file-code"></i> results.tex
                            </li>
                        </div>
                    </ul>
                </div>
            </div>
            <div class="sidebar-section">
                <h3><i class="fas fa-users"></i> Collaborators</h3>
                <div id="collaboratorsList">
                    <div class="user-item">
                        <div class="user-avatar">DB</div>
                        <span>dbarros1979 (You)</span>
                    </div>
                    <div class="user-item">
                        <div class="user-avatar" style="background-color: var(--secondary-color);">JD</div>
                        <span>jdoe</span>
                    </div>
                    <div class="user-item">
                        <div class="user-avatar" style="background-color: var(--warning-color);">AS</div>
                        <span>asmith</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Editor area with tabs and panels -->
        <div class="editor-area">
            <div class="editor-tabs" id="editorTabs">
                <div class="editor-tab active" data-file="main.tex">
                    <i class="fas fa-file-code"></i> main.tex
                    <span class="editor-tab-close"><i class="fas fa-times"></i></span>
                </div>
                <!-- More tabs would appear here as files are opened -->
            </div>

            <div class="editor-container">
                <!-- Code editor panel -->
                <div class="code-panel">
                    <div class="panel-header">
                        <span class="panel-title" id="currentFile">main.tex</span>
                        <div class="panel-controls">
                            <button class="btn btn-secondary" id="undoBtn" title="Undo">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="btn btn-secondary" id="redoBtn" title="Redo">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button class="btn btn-secondary" id="wordCountBtn" title="Word Count">
                                <i class="fas fa-font"></i>
                            </button>
                        </div>
                    </div>
                    <div id="texEditor"></div>
                </div>

                <!-- Resize handle -->
                <div class="resize-handle" id="resizeHandle"></div>

                <!-- PDF preview panel -->
                <div class="preview-panel">
                    <div class="panel-header">
                        <span class="panel-title">PDF Preview</span>
                        <div class="panel-controls">
                            <button class="btn btn-secondary" id="zoomOutBtn" title="Zoom Out">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="btn btn-secondary" id="zoomInBtn" title="Zoom In">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="btn btn-secondary" id="fullscreenBtn" title="Fullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="btn btn-secondary" id="downloadBtn" title="Download PDF">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <iframe id="pdfFrame" src="main/main.pdf"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Compilation log -->
    <div class="compilation-log" id="compilationLog">
        <div class="log-header">
            <span>Compilation Log</span>
            <button class="btn btn-secondary" id="toggleLog">
                <i class="fas fa-chevron-up"></i>
            </button>
        </div>
        <div class="log-content" id="logContent"></div>
    </div>

    <!-- Footer with status information -->
    <div class="footer">
        <div class="status-indicators">
            <div class="status-item">
                <i class="fas fa-circle" id="connectionStatus" style="color: var(--secondary-color);"></i>
                <span>Connected</span>
            </div>
            <div class="status-item">
                <i class="fas fa-save" id="saveStatus"></i>
                <span>All changes saved</span>
            </div>
            <div class="status-item">
                <i class="fas fa-code" id="latexStatus"></i>
                <span>LaTeX</span>
            </div>
        </div>
        <div class="status-item">
            <span id="statusMessage">Ready</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/stex/stex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/scroll/simplescrollbars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/comment-fold.min.js"></script>

    <script>
        // Application state
        let currentBranch = 'main';
        let currentFile = 'main.tex';
        let fileContents = {};
        let openTabs = ['main.tex'];
        let isCompiling = false;
        let isLoggedIn = false; // Would be set based on authentication
        let editor; // CodeMirror editor instance
        let editHistory = {};
        let editHistoryIndex = {};

        // DOM elements
        const branchDropdownBtn = document.getElementById('branchDropdownBtn');
        const branchDropdown = document.getElementById('branchDropdown');
        const currentBranchDisplay = document.getElementById('currentBranchDisplay');
        const newBranchBtn = document.getElementById('newBranchBtn');
        const manageBranchesBtn = document.getElementById('manageBranchesBtn');
        const fileList = document.getElementById('fileList');
        const editorTabs = document.getElementById('editorTabs');
        const texEditor = document.getElementById('texEditor');
        const pdfFrame = document.getElementById('pdfFrame');
        const currentFileElement = document.getElementById('currentFile');
        const compileBtn = document.getElementById('compileBtn');
        const reloadBtn = document.getElementById('reloadBtn');
        const saveBtn = document.getElementById('saveBtn');
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        const wordCountBtn = document.getElementById('wordCountBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const toggleLog = document.getElementById('toggleLog');
        const compilationLog = document.getElementById('compilationLog');
        const logContent = document.getElementById('logContent');
        const statusMessage = document.getElementById('statusMessage');
        const connectionStatus = document.getElementById('connectionStatus');
        const saveStatus = document.getElementById('saveStatus');
        const latexStatus = document.getElementById('latexStatus');
        const resizeHandle = document.getElementById('resizeHandle');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
            setupEventListeners();
            loadBranch();
            loadFile('main.tex');
        });

        // Initialize application state and UI
        function initializeApp() {
            // Set up initial file contents (in a real app, this would come from GitHub API)
            fileContents['main.tex'] = `\\documentclass{article}
\\usepackage[utf8]{inputenc}
\\usepackage{graphicx}
\\usepackage{amsmath}

\\title{Collab-Tex: A Collaborative LaTeX Editor}
\\author{Your Name}
\\date{\\today}

\\begin{document}

\\maketitle

\\section{Introduction}
This is a collaborative LaTeX document edited using Collab-Tex.

\\section{Features}
\\begin{itemize}
    \\item Real-time collaboration
    \\item Automatic PDF compilation
    \\item GitHub integration
    \\item Overleaf-like interface
\\end{itemize}

\\section{Mathematical Content}
We can include mathematical formulas like this:
\\[
    E = mc^2
\\]
Or inline formulas like $\\sum_{i=1}^{n} i = \\frac{n(n+1)}{2}$.

\\section{Conclusion}
Collab-Tex makes LaTeX collaboration simple and accessible.

\\bibliographystyle{plain}
\\bibliography{references}

\\end{document}`;

            fileContents['references.bib'] = `@article{collabtex2023,
    title = {Collab-Tex: Redesigning Academic LaTeX Collaboration},
    author = {Author, A. and Collaborator, B.},
    journal = {Journal of Open Source Software},
    year = {2023},
    volume = {8},
    number = {90},
    pages = {1--5}
}`;

            fileContents['sections/introduction.tex'] = `\\section{Introduction}
This is the introduction section of our document.

\\subsection{Motivation}
The motivation behind this work is to create a better collaborative LaTeX editor.`;

            fileContents['sections/methodology.tex'] = `\\section{Methodology}
This section describes our methodology.

\\subsection{Approach}
We followed a user-centered design approach.`;

            fileContents['sections/results.tex'] = `\\section{Results}
This section presents our results.

\\subsection{Performance}
The performance of our system exceeded expectations.`;

            // Initialize edit history for each file
            for (const file in fileContents) {
                editHistory[file] = [fileContents[file]];
                editHistoryIndex[file] = 0;
            }

            // Initialize CodeMirror editor
            editor = CodeMirror(texEditor, {
                mode: "stex",
                theme: "monokai",
                lineNumbers: true,
                lineWrapping: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                styleActiveLine: true,
                scrollbarStyle: "simple",
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: {
                    "Ctrl-S": saveFile,
                    "Cmd-S": saveFile,
                    "Ctrl-Enter": compileProject,
                    "Cmd-Enter": compileProject,
                    "Ctrl-Z": undoEdit,
                    "Cmd-Z": undoEdit,
                    "Ctrl-Y": redoEdit,
                    "Shift-Ctrl-Y": redoEdit,
                    "Cmd-Y": redoEdit,
                    "Shift-Cmd-Y": redoEdit,
                    "Tab": "indentMore",
                    "Shift-Tab": "indentLess"
                }
            });

            // Update UI state
            updateSaveStatus(true);
            updateConnectionStatus(true);
        }

        // Set up all event listeners
        function setupEventListeners() {
            // Branch selection
            branchDropdownBtn.addEventListener('click', toggleBranchDropdown);
            document.addEventListener('click', closeBranchDropdown);

            // Branch actions
            newBranchBtn.addEventListener('click', createNewBranch);
            manageBranchesBtn.addEventListener('click', manageBranches);

            // Branch items
            document.querySelectorAll('.branch-item').forEach(item => {
                item.addEventListener('click', function () {
                    if (!this.classList.contains('active')) {
                        switchBranch(this.getAttribute('data-branch'));
                    }
                });
            });

            // Control buttons
            compileBtn.addEventListener('click', compileProject);
            reloadBtn.addEventListener('click', reloadPDF);
            saveBtn.addEventListener('click', saveFile);
            undoBtn.addEventListener('click', undoEdit);
            redoBtn.addEventListener('click', redoEdit);
            wordCountBtn.addEventListener('click', showWordCount);
            zoomOutBtn.addEventListener('click', zoomOutPDF);
            zoomInBtn.addEventListener('click', zoomInPDF);
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            downloadBtn.addEventListener('click', downloadPDF);
            toggleLog.addEventListener('click', toggleCompilationLog);

            // File navigation
            fileList.addEventListener('click', handleFileClick);

            // Editor tabs
            editorTabs.addEventListener('click', handleTabClick);

            // Text editor changes
            editor.on('change', handleEditorChange);

            // Resize handle for panels
            setupResizeHandle();

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        // Toggle branch dropdown
        function toggleBranchDropdown(e) {
            e.stopPropagation();
            branchDropdown.classList.toggle('show');
        }

        // Close branch dropdown when clicking outside
        function closeBranchDropdown(e) {
            if (!branchDropdown.contains(e.target) && e.target !== branchDropdownBtn) {
                branchDropdown.classList.remove('show');
            }
        }

        // Switch to a different branch
        function switchBranch(branchName) {
            // Update active branch in UI
            document.querySelectorAll('.branch-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.branch-item[data-branch="${branchName}"]`).classList.add('active');

            currentBranch = branchName;
            currentBranchDisplay.textContent = branchName;

            // Close dropdown
            branchDropdown.classList.remove('show');

            // Load branch content
            loadBranch();
        }

        // Create a new branch
        function createNewBranch() {
            const branchName = prompt('Enter new branch name:');
            if (branchName && branchName.trim() !== '') {
                // In a real app, this would create a new branch via GitHub API
                addToLog(`Creating new branch: ${branchName}`, 'info');

                // Add to UI
                const newBranchItem = document.createElement('div');
                newBranchItem.className = 'branch-item';
                newBranchItem.setAttribute('data-branch', branchName);
                newBranchItem.innerHTML = `<span>${branchName}</span>`;

                // Insert before the branch actions
                branchDropdown.insertBefore(newBranchItem, document.querySelector('.branch-actions'));

                // Add event listener
                newBranchItem.addEventListener('click', function () {
                    switchBranch(branchName);
                });

                statusMessage.textContent = `Created branch: ${branchName}`;
            }
        }

        // Manage branches
        function manageBranches() {
            addToLog('Opening branch management...', 'info');
            statusMessage.textContent = 'Branch management (simulated)';
            // In a real app, this would open a branch management modal
        }

        // Handle file clicks in the sidebar
        function handleFileClick(e) {
            const fileItem = e.target.closest('.file-item');
            const folderItem = e.target.closest('.folder-item');

            if (fileItem) {
                const fileName = fileItem.getAttribute('data-file');
                openFile(fileName);
            } else if (folderItem) {
                folderItem.classList.toggle('expanded');
            }
        }

        // Handle tab clicks in the editor area
        function handleTabClick(e) {
            const tab = e.target.closest('.editor-tab');
            const closeBtn = e.target.closest('.editor-tab-close');

            if (closeBtn && tab) {
                closeTab(tab.getAttribute('data-file'));
            } else if (tab) {
                switchToTab(tab.getAttribute('data-file'));
            }
        }

        // Handle editor input changes
        function handleEditorChange() {
            const content = editor.getValue();
            fileContents[currentFile] = content;

            // Add to edit history if content changed
            if (editHistory[currentFile][editHistoryIndex[currentFile]] !== content) {
                editHistoryIndex[currentFile]++;
                editHistory[currentFile][editHistoryIndex[currentFile]] = content;

                // Remove any future history if we're not at the end
                if (editHistoryIndex[currentFile] < editHistory[currentFile].length - 1) {
                    editHistory[currentFile] = editHistory[currentFile].slice(0, editHistoryIndex[currentFile] + 1);
                }

                // Limit history size
                if (editHistory[currentFile].length > 50) {
                    editHistory[currentFile].shift();
                    editHistoryIndex[currentFile]--;
                }
            }

            updateSaveStatus(false);
            updateUndoRedoButtons();
        }

        // Handle keyboard shortcuts
        function handleKeyboardShortcuts(e) {
            // Ctrl+S or Cmd+S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveFile();
            }

            // Ctrl+Enter or Cmd+Enter to compile
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                compileProject();
            }
        }

        // Set up resize handle for editor panels
        function setupResizeHandle() {
            let isResizing = false;

            resizeHandle.addEventListener('mousedown', function (e) {
                isResizing = true;
                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
            });

            function handleResize(e) {
                if (!isResizing) return;

                const container = document.querySelector('.editor-container');
                const containerRect = container.getBoundingClientRect();
                const percentage = (e.clientX - containerRect.left) / containerRect.width;

                document.querySelector('.code-panel').style.flex = percentage;
                document.querySelector('.preview-panel').style.flex = 1 - percentage;
            }

            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        // Load selected branch
        function loadBranch() {
            statusMessage.textContent = `Loading branch: ${currentBranch}`;

            // Update PDF preview
            const pdfUrl = `https://dbarros1979.github.io/collab-tex/${currentBranch}/main.pdf`;
            pdfFrame.src = pdfUrl;

            // In a real implementation, we would fetch the file list from GitHub API
            simulateFileListLoad();

            statusMessage.textContent = `Branch loaded: ${currentBranch}`;
            addToLog(`Switched to branch: ${currentBranch}`, 'info');
        }

        // Simulate loading file list (would use GitHub API in production)
        function simulateFileListLoad() {
            statusMessage.textContent = 'File list loaded from repository';
        }

        // Open a file in the editor
        function openFile(fileName) {
            // Update file list selection
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.file-item[data-file="${fileName}"]`).classList.add('active');

            // Add tab if not already open
            if (!openTabs.includes(fileName)) {
                openTabs.push(fileName);
                addTab(fileName);
            }

            // Switch to the tab
            switchToTab(fileName);
        }

        // Add a new editor tab
        function addTab(fileName) {
            const tab = document.createElement('div');
            tab.className = 'editor-tab';
            tab.setAttribute('data-file', fileName);

            // Extract file icon based on extension
            const icon = getFileIcon(fileName);
            const name = fileName.split('/').pop();

            tab.innerHTML = `
                ${icon} ${name}
                <span class="editor-tab-close"><i class="fas fa-times"></i></span>
            `;

            editorTabs.appendChild(tab);
        }

        // Switch to a specific tab
        function switchToTab(fileName) {
            // Update tab states
            document.querySelectorAll('.editor-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.editor-tab[data-file="${fileName}"]`).classList.add('active');

            // Update current file and load content
            currentFile = fileName;
            currentFileElement.textContent = fileName;

            // Set editor content
            editor.setValue(fileContents[fileName] || '');

            // Update save status
            updateSaveStatus(true);
            updateUndoRedoButtons();
        }

        // Close a tab
        function closeTab(fileName) {
            // Don't close the last tab
            if (openTabs.length <= 1) return;

            // Remove from open tabs
            const tabIndex = openTabs.indexOf(fileName);
            openTabs.splice(tabIndex, 1);

            // Remove tab element
            const tabElement = document.querySelector(`.editor-tab[data-file="${fileName}"]`);
            tabElement.remove();

            // If we're closing the active tab, switch to another one
            if (currentFile === fileName) {
                const newActiveTab = openTabs[Math.max(0, tabIndex - 1)];
                switchToTab(newActiveTab);
            }
        }

        // Get appropriate file icon based on extension
        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            switch (ext) {
                case 'tex': return '<i class="fas fa-file-code"></i>';
                case 'bib': return '<i class="fas fa-file-alt"></i>';
                case 'png':
                case 'jpg':
                case 'jpeg':
                case 'gif': return '<i class="fas fa-file-image"></i>';
                case 'pdf': return '<i class="fas fa-file-pdf"></i>';
                default: return '<i class="fas fa-file"></i>';
            }
        }

        // Compile the LaTeX project
        function compileProject() {
            if (isCompiling) return;

            isCompiling = true;
            compileBtn.classList.add('compiling');
            statusMessage.textContent = 'Compiling...';

            // In a real implementation, this would trigger a GitHub Actions workflow
            // For now, we simulate the compilation process
            simulateCompilation();
        }

        // Simulate the compilation process
        function simulateCompilation() {
            addToLog('Starting compilation...', 'info');

            // Simulate compilation steps with delays
            setTimeout(() => {
                addToLog('Running pdflatex...', 'info');
            }, 500);

            setTimeout(() => {
                addToLog('Running bibtex...', 'info');
            }, 1000);

            setTimeout(() => {
                addToLog('Running pdflatex (second pass)...', 'info');
            }, 1500);

            setTimeout(() => {
                addToLog('Running pdflatex (final pass)...', 'info');
                addToLog('Compilation successful!', 'success');

                isCompiling = false;
                compileBtn.classList.remove('compiling');
                statusMessage.textContent = 'Compilation complete';

                // Reload PDF after a short delay to ensure it's updated
                setTimeout(() => {
                    reloadPDF();
                }, 300);
            }, 2000);
        }

        // Reload the PDF preview
        function reloadPDF() {
            const currentSrc = pdfFrame.src;
            pdfFrame.src = currentSrc.split('?')[0] + '?t=' + new Date().getTime();
            statusMessage.textContent = 'PDF reloaded';
        }

        // Save the current file
        function saveFile() {
            // In a real implementation, this would commit changes to GitHub
            statusMessage.textContent = `Saving ${currentFile}...`;

            // Simulate API call delay
            setTimeout(() => {
                statusMessage.textContent = `Saved: ${currentFile}`;
                updateSaveStatus(true);
                addToLog(`Saved ${currentFile}`, 'info');
            }, 500);
        }

        // Undo last edit
        function undoEdit() {
            if (editHistoryIndex[currentFile] > 0) {
                editHistoryIndex[currentFile]--;
                const content = editHistory[currentFile][editHistoryIndex[currentFile]];
                editor.setValue(content);
                fileContents[currentFile] = content;
                updateUndoRedoButtons();
                statusMessage.textContent = 'Undo';
            }
        }

        // Redo last undone edit
        function redoEdit() {
            if (editHistoryIndex[currentFile] < editHistory[currentFile].length - 1) {
                editHistoryIndex[currentFile]++;
                const content = editHistory[currentFile][editHistoryIndex[currentFile]];
                editor.setValue(content);
                fileContents[currentFile] = content;
                updateUndoRedoButtons();
                statusMessage.textContent = 'Redo';
            }
        }

        // Update undo/redo button states
        function updateUndoRedoButtons() {
            undoBtn.disabled = editHistoryIndex[currentFile] <= 0;
            redoBtn.disabled = editHistoryIndex[currentFile] >= editHistory[currentFile].length - 1;
        }

        // Show word count
        function showWordCount() {
            const content = editor.getValue();
            const words = content.split(/\s+/).filter(word => word.length > 0).length;
            const characters = content.length;
            statusMessage.textContent = `Words: ${words}, Characters: ${characters}`;
        }

        // Zoom out PDF
        function zoomOutPDF() {
            // In a real implementation, this would adjust the iframe zoom level
            statusMessage.textContent = 'Zooming out PDF';
        }

        // Zoom in PDF
        function zoomInPDF() {
            // In a real implementation, this would adjust the iframe zoom level
            statusMessage.textContent = 'Zooming in PDF';
        }

        // Toggle fullscreen mode for PDF preview
        function toggleFullscreen() {
            if (pdfFrame.requestFullscreen) {
                pdfFrame.requestFullscreen();
            } else if (pdfFrame.webkitRequestFullscreen) {
                pdfFrame.webkitRequestFullscreen();
            }
            // Note: Fullscreen API has limited support for iframes
            statusMessage.textContent = 'Fullscreen mode';
        }

        // Download the current PDF
        function downloadPDF() {
            const pdfUrl = pdfFrame.src;
            const a = document.createElement('a');
            a.href = pdfUrl;
            a.download = `document-${currentBranch}-${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            statusMessage.textContent = 'Downloading PDF...';
        }

        // Toggle compilation log visibility
        function toggleCompilationLog() {
            const isVisible = compilationLog.style.display !== 'none';
            compilationLog.style.display = isVisible ? 'none' : 'block';
            toggleLog.innerHTML = isVisible ?
                '<i class="fas fa-chevron-down"></i>' :
                '<i class="fas fa-chevron-up"></i>';
        }

        // Add a message to the compilation log
        function addToLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        // Update the save status indicator
        function updateSaveStatus(saved) {
            if (saved) {
                saveStatus.className = 'fas fa-check';
                saveStatus.style.color = 'var(--secondary-color)';
            } else {
                saveStatus.className = 'fas fa-circle';
                saveStatus.style.color = 'var(--warning-color)';
            }
        }

        // Update the connection status indicator
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.style.color = 'var(--secondary-color)';
            } else {
                connectionStatus.style.color = 'var(--danger-color)';
            }
        }

        // Load file content into editor
        function loadFile(fileName) {
            currentFile = fileName;
            currentFileElement.textContent = fileName;

            // In a real implementation, this would fetch content from GitHub API
            if (fileContents[fileName]) {
                editor.setValue(fileContents[fileName]);
            } else {
                const defaultContent = `% File: ${fileName}\n% This file is empty. Start editing!`;
                editor.setValue(defaultContent);
                fileContents[fileName] = defaultContent;

                // Initialize edit history for new file
                editHistory[fileName] = [defaultContent];
                editHistoryIndex[fileName] = 0;
            }

            updateUndoRedoButtons();
            statusMessage.textContent = `Loaded: ${fileName}`;
        }
    </script>
</body>

</html>